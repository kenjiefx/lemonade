<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Module Previewer</title>
    <link rel="stylesheet" href="/app/global.css">
    <link rel="stylesheet" href="/venta/app.css">
    <link rel="stylesheet" href="/dev/style.css">
    <!--<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/rterrado/beta/strawberry-js/v1.2.0.js"></script>-->
    <script type="text/javascript" src="/app/strawberry.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="/app/main.js"></script>
    <!--Font Declarations-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;400;500;700;800&family=Rubik:wght@300;400;700&display=swap" rel="stylesheet">
    <!--Third Party Library-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
  </head>
  <body>
    <app xscope="previewer">
      <section id="loader" class="loading-container">
        <div class="loading-container-wrapper">
          <img class="loader-spinner-icon" src="https://cdn.shopify.com/s/files/1/0560/7466/6159/files/spinner.gif?v=1646281504">
        </div>
      </section>
      <main id="main">
        <div class="preview-wrapper w-inherit">
          <section xcomponent="preview" class="preview-container"></section>
        </div>
      </main>
    </app>
    <script type="text/javascript">
      app.scope('previewer',['presets,modules','Requester'],function($scope,AjaxSvc,UserSvc,ProjectSvc,Utils,PostSvc,ProjectModel){

        /** For Testing Only **/
        $scope.Requester.status = 'online';
        $scope.Requester.profilePhoto = null;
        $scope.Requester.name = 'Kenjie Terrado';
        $scope.Requester.username = 'rterrado';
        /** End: For Testing Only **/

        /** Official Here **/
        $scope.Utils = Utils;
        $scope.PostSvc = PostSvc;
        $scope.ProjectSvc = new ProjectSvc();
        $scope.ProjectModel = new ProjectModel();
        /** End Official **/

        let Params = new URLSearchParams(window.location.search);

        let getUser = function(){
          let user = Params.get('user');
          if (null===user) user = 'rterrado';
          return user;
        }

        let getView = function(){
          let module = Params.get('view');
          if (null===module) module = 'page-error';
          return '/modules/'+module;
        }

        let getProject = function(){
          return Params.get('project');
        }

        $scope.preview = getView()+'.htm';

        // Loads in user data
        AjaxSvc.get({
          url:'/dev/data/profile/'+getUser()+'.json',
          success:function(response){
            $scope.UserSvc = new UserSvc(response);
            AjaxSvc.get({
              url:'/dev/data/settings/'+getUser()+'.json',
              success:function(response){
                $scope.UserSvc.settings(response).apply();
              },
              error:function(){

              }
            });
          },
          error:function(){

          }
        });


        // Loads in Project data
        if (getProject()!==null) {
            AjaxSvc.get({
              url:'/dev/data/project/'+getProject()+'.json',
              success:function(response){
                console.log('getting project');
                $scope.ProjectModel.setProject(response);
                $scope.ProjectSvc.patch();
              },
              error:function(){

              }
            });
            AjaxSvc.get({
              url:'/dev/data/dynamic/'+getProject()+'.json',
              success:function(response){
                console.log('getting dynamic data about project');
                $scope.ProjectModel.setMetrics(response.metrics);
                $scope.ProjectModel.setPostList(response.posts);
                $scope.ProjectModel.setRequester(response.requester);
                $scope.ProjectSvc.patch();
              },
              error:function(){

              }
            });
        }
      });
    </script>
  </body>
</html>
